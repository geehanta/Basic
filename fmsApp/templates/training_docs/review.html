{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load customfilter %}

{% block pageContent %}
<div id="app-container" class="container-fluid main-container">
    <!-- ================= HEADER ================= -->
    <div class="header-section d-flex justify-content-between align-items-center">
        <div>
            <h3 class="m-0">
                {% if "reviewer" in roles and "staff" in roles %}
                    Training Docs Review & Upload
                {% elif "reviewer" in roles %}
                    Training Docs Review
                {% elif "staff" in roles %}
                    Training Docs Upload
                {% else %}
                    Unauthorized Access!
                {% endif %}
            </h3>
            <span class="version-tag" style="font-size: 0.7rem; font-weight: 500; color: #6c757d;">VERSION .05 FEB 2025</span>
        </div>
        <div>
            {% if "reviewer" in roles %}
                <button id="review-document-btn" class="btn btn-primary reviewer-only"
                        data-bs-toggle="modal" data-bs-target="#reviewModal" disabled>
                    <i class="fas fa-check-circle me-1"></i> Review Documents
                </button>
            {% endif %}
            {% if "staff" in roles %}
                <button id="upload-document-btn" class="btn btn-success upload-btn"
                        data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-plus me-1"></i> Upload Documents
                </button>
            {% endif %}
        </div>
    </div>

    <!-- ================= BADGE BAR ================= -->
    <div class="bg-light p-2 border-bottom">
        <span class="badge bg-secondary">Total Files Uploaded: {{ documents|length }}</span>
    </div>

    <!-- ================= TABS ================= -->
    <ul class="nav nav-tabs custom-tabs" id="documentTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="section1-tab" data-bs-toggle="tab" 
                    data-bs-target="#section1" type="button">
                Section 1
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="section2-tab" data-bs-toggle="tab" 
                    data-bs-target="#section2" type="button">
                Section 2
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="section3-tab" data-bs-toggle="tab" 
                    data-bs-target="#section3" type="button">
                Section 3
            </button>
        </li>
    </ul>

    <!-- ================= TAB CONTENT ================= -->
    <div class="tab-content mt-3" id="documentTabsContent">

        <!-- SECTION 1 -->
        <div class="tab-pane fade show active" id="section1">
            <div class="row">
                <!-- Left checklist -->
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header section-header">Verification of Job Qualifications</div>
                        <ul class="list-group list-group-flush">
                            {% for item in section_items.section1 %}
                                <li class="list-group-item d-flex justify-content-between align-items-center list-item-click"
                                    data-section="section1"
                                    data-doctype="{{ item.name }}"
                                    data-bs-toggle="tooltip"
                                    data-bs-title="{{ item.tooltip }}">
                                    {{ item.num }}. {{ item.name }}
                                    {% with section_counts=doc_counts.section1 %}
                                        {% if section_counts|get:item.name %}
                                            <span class="badge bg-success">{{ section_counts|get:item.name }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Not uploaded</span>
                                        {% endif %}
                                    {% endwith %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Right table -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header section-header">Documents Review Status</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table id="documentTable" class="table table-bordered table-hover table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Uploaded By</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>                                      
                                        {% for doc in section_docs.section1 %}
                                        <tr>
                                            <td>{{ doc.doc_type }}</td>
                                            <td>{{ doc.uploaded_by }}</td>
                                            <td>{{ doc.uploaded_at|date:"Y-m-d" }}</td>
                                            <td>
                                                <span class="doc-status {{ doc.status|lower }}">
                                                    {{ doc.status }}
                                                </span>
                                            </td>
                                            <td  class="action-buttons">
                                                
                                                {% if "reviewer" in roles %}
                                                    <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-info">Preview</a>
                                                    <button class="btn btn-sm btn-primary"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#reviewModal"
                                                            data-doc="{{ doc.id }}"
                                                            data-doctype="{{ doc.doc_type }}"
                                                            data-description="{{ doc.description }}"
                                                            data-status="{{ doc.status }}"
                                                            data-feedback="{{ doc.reviewer_feedback }}">
                                                        Review
                                                    </button>
                                                {% endif %}

                                                {% if "staff" in roles %}
                                                    <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-info">Preview</a>
                                                    <button class="btn btn-sm btn-warning"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#uploadModal"
                                                            data-doc="{{ doc.id }}"
                                                            data-section="{{ doc.section }}"
                                                            data-doctype="{{ doc.doc_type }}"
                                                            data-description="{{ doc.description }}">
                                                        Update
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-btn"
                                                            data-doc="{{ doc.id }}"
                                                            data-docname="{{ doc.doc_type }}">
                                                        Delete
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                            <tr><td colspan="6" class="text-center">No documents in this section yet.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2 -->
        <div class="tab-pane fade" id="section2">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header section-header">Department orientation Records</div>
                        <ul class="list-group list-group-flush">
                            {% for item in section_items.section2 %}
                                <li class="list-group-item d-flex justify-content-between align-items-center list-item-click"
                                    data-section="section2"
                                    data-doctype="{{ item.name }}"
                                    data-bs-toggle="tooltip"
                                    data-bs-title="{{ item.tooltip }}">
                                    {{ item.num }}. {{ item.name }}
                                    {% with section_counts=doc_counts.section2 %}
                                        {% if section_counts|get:item.name %}
                                            <span class="badge bg-success">{{ section_counts|get:item.name }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Not uploaded</span>
                                        {% endif %}
                                    {% endwith %}

                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header section-header">Uploaded Files</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table id="documentTable" class="table table-bordered table-hover table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Uploaded By</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>                                      
                                        {% for doc in section_docs.section2 %}
                                        <tr>
                                            <td>{{ doc.doc_type }}</td>
                                            <td>{{ doc.uploaded_by }}</td>
                                            <td>{{ doc.uploaded_at|date:"Y-m-d" }}</td>
                                            <td>
                                                <span class="doc-status {{ doc.status|lower }}">
                                                    {{ doc.status }}
                                                </span>
                                            </td>
                                            <td  class="action-buttons">
                                                
                                                {% if "reviewer" in roles %}
                                                    <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-info">Preview</a>
                                                    <button class="btn btn-sm btn-primary"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#reviewModal"
                                                            data-doc="{{ doc.id }}"
                                                            data-doctype="{{ doc.doc_type }}"
                                                            data-description="{{ doc.description }}"
                                                            data-status="{{ doc.status }}"
                                                            data-feedback="{{ doc.reviewer_feedback }}">
                                                        Review
                                                    </button>
                                                {% endif %}

                                                {% if "staff" in roles %}
                                                    <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-info">Preview</a>
                                                    <button class="btn btn-sm btn-warning"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#uploadModal"
                                                            data-doc="{{ doc.id }}"
                                                            data-section="{{ doc.section }}"
                                                            data-doctype="{{ doc.doc_type }}"
                                                            data-description="{{ doc.description }}">
                                                        Update
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-btn"
                                                            data-doc="{{ doc.id }}"
                                                            data-docname="{{ doc.doc_type }}">
                                                        Delete
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                            <tr><td colspan="6" class="text-center">No documents in this section yet.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3 -->
        <div class="tab-pane fade" id="section3">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header section-header">Education, Training, Competency</div>
                            <ul class="list-group list-group-flush">
                                {% for item in section_items.section3 %}
                                    {% if item.categories %}
                                        <!-- PARENT ITEM -->
                                        <li class="list-group-item">
                                            <div class="fw-bold mb-2">{{ item.num }}. {{ item.name }}</div>
                                            <!-- <ul class="list-group ms-3 border-start ps-2"> -->
                                            <ul class="list-group sublist  ps-0"> </ul>                                          
                                                {% for category, subitems in item.categories.items %}
                                                    {% for sub in subitems %}
                                                        <li class="list-group-item d-flex justify-content-between align-items-center list-item-click py-1"
                                                            data-section="section3"
                                                            data-doctype="{{ sub.name }}"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-title="{{ sub.tooltip }}">
                                                            <span>{{ sub.name }}</span>
                                                            {% if sub.count %}
                                                                <span class="badge bg-success">{{ sub.count }}</span>
                                                            {% else %}
                                                                <span class="badge bg-secondary">Not uploaded</span>
                                                            {% endif %}
                                                        </li>
                                                    {% endfor %}
                                                {% endfor %}
                                            </ul>
                                        </li>

                                    {% else %}
                                        <!-- NORMAL ITEM -->
                                        <li class="list-group-item d-flex justify-content-between align-items-center list-item-click ms-3 border-bottom"
                                            data-section="section3"
                                            data-doctype="{{ item.name }}"
                                            data-bs-toggle="tooltip"
                                            data-bs-title="{{ item.tooltip }}">
                                            {{ item.num }}. {{ item.name }}
                                            {% if item.count %}
                                                <span class="badge bg-success">{{ item.count }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Not uploaded</span>
                                            {% endif %}
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                    </div>
                    </div>

                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header section-header">Uploaded Files</div>
                        <div class="card-body">
                            <p class="text-muted text-center">No documents uploaded in this section.</p>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table id="documentTable" class="table table-bordered table-hover table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Uploaded By</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>                                      
                                        {% for doc in section_docs.section3 %}
                                        <tr>
                                            <td>{{ doc.doc_type }}</td>
                                            <td>{{ doc.uploaded_by }}</td>
                                            <td>{{ doc.uploaded_at|date:"Y-m-d" }}</td>
                                            <td>
                                                <span class="doc-status {{ doc.status|lower }}">
                                                    {{ doc.status }}
                                                </span>
                                            </td>
                                            <td  class="action-buttons">
                                                
                                                {% if "reviewer" in roles %}
                                                    <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-info">Preview</a>
                                                    <button class="btn btn-sm btn-primary"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#reviewModal"
                                                            data-doc="{{ doc.id }}"
                                                            data-doctype="{{ doc.doc_type }}"
                                                            data-description="{{ doc.description }}"
                                                            data-status="{{ doc.status }}"
                                                            data-feedback="{{ doc.reviewer_feedback }}">
                                                        Review
                                                    </button>
                                                {% endif %}

                                                {% if "staff" in roles %}
                                                    <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-info">Preview</a>
                                                    <button class="btn btn-sm btn-warning"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#uploadModal"
                                                            data-doc="{{ doc.id }}"
                                                            data-section="{{ doc.section }}"
                                                            data-doctype="{{ doc.doc_type }}"
                                                            data-description="{{ doc.description }}">
                                                        Update
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-btn"
                                                            data-doc="{{ doc.id }}"
                                                            data-docname="{{ doc.doc_type }}">
                                                        Delete
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                            <tr><td colspan="6" class="text-center">No documents in this section yet.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ================= UPLOAD MODAL (Staff) ================= -->

{% if "staff" in roles %}
<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="uploadForm" class="modal-content" method="post" enctype="multipart/form-data"
          action="{% url 'upload_document' %}">
      {% csrf_token %}
      <input type="hidden" name="doc_id" id="uploadDocId">

      <div class="modal-header">
        <h5 class="modal-title">Upload Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="section" class="form-label">Section</label>
          <select class="form-select" id="section" name="section" required>
            <option value="" disabled selected>Select a section</option>
            {% for value, label in documents.model.SECTION_CHOICES %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="documentType" class="form-label">Document Type</label>
          <select class="form-select" id="documentType" name="doc_type" required disabled>
            <option value="" disabled selected>Select a section first</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea class="form-control" id="description" name="description"></textarea>
        </div>

        <div class="mb-3">
          <label for="file" class="form-label">File</label>
          <input type="file" class="form-control" id="file" name="file" accept=".pdf,.docx,.xlsx" multiple>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" id="saveDocumentBtn" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>
{% endif %}


<!-- ================= REVIEW MODAL (Reviewer) ================= -->

{% if "reviewer" in roles %}
<div class="modal fade" id="reviewModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="reviewForm" class="modal-content" method="post">
      {% csrf_token %}
      <input type="hidden" name="doc_id" id="reviewDocId">

      <div class="modal-header">
        <h5 class="modal-title">Review Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
            <label class="form-label">Document</label>
            <p id="reviewDocumentName" class="form-control-plaintext"></p>
          <label for="status" class="form-label">Status</label>
          <select class="form-select" id="status" name="status" required>
            {% for value, label in documents.model.STATUS_CHOICES %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="reviewer_feedback" class="form-label">Reviewer Feedback</label>
          <textarea class="form-control" id="reviewer_feedback" name="reviewer_feedback"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>
{% endif %}
{% endblock pageContent %}

{% block ScriptBlock %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<!-- ========== Django data for JS use ========== -->
<!-- <script id="section-items" type="application/json">
    {{ section_items|safe|json_script:"section-items" }}
</script> -->
{{ section_items|json_script:"section-items" }}

<script>

document.addEventListener("DOMContentLoaded", function () {
    const sectionItemsScript = document.getElementById("section-items");
    window.sectionItems = sectionItemsScript ? JSON.parse(sectionItemsScript.textContent) : {};
    // --- Bootstrap toasts ---
    document.querySelectorAll(".toast").forEach(toastEl => {
        new bootstrap.Toast(toastEl, { delay: 4000 }).show();
    });

    // --- Enable all tooltips ---
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
});

// --- Delete confirmation ---
$(document).on("click", ".delete-btn", function () {
    const docId = $(this).data("doc");
    const docName = $(this).data("docname");
    if (confirm(`Are you sure you want to delete "${docName}"?`)) {
        window.location.href = `/documents/delete/${docId}/`;
    }
});

// --- Make list items clickable (for modal prefill) ---
$(document).on("click", ".list-item-click", function (e) {
    e.preventDefault();

    // Remove previous highlights and set active
    $(".list-item-click").removeClass("active-item");
    $(this).addClass("active-item");

    const section = $(this).data("section");
    const docType = $(this).data("doctype");

    // Show modal
    $("#uploadModal").modal("show");

    // Prefill section (triggers section change)
    $("#section").val(section).trigger("change");

    // When section types are ready, select the right document type
    $(document).one("typesPopulated", function () {
        $("#documentType").val(docType).trigger("change");
    });
});


// --- Add teal highlight style dynamically ---
// --- Add modern highlight style dynamically ---
// --- Add highlight style dynamically ---
$("<style>")
    .prop("type", "text/css")
    .html(`
        /* Default state */
        .list-item-click {
            background-color: #fff;
            color: #212529;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
            /* Scrollable left panel */
        .col-lg-4 .card {
            max-height: 550px; /* adjust as needed */
            overflow-y: auto;
        }

        /* Hover effect */
        .list-item-click:hover {
            background-color: #f8f9fa;
        }

        /* Selected / active item (keep teal background) */
        .active-item {
            background-color: teal !important;
            color: #fff !important;
            font-weight: 500;
        }

        /* Subitems inside dropdowns */
        .dropdown-menu .list-item-click {
            color: #212529;
            background-color: #fff;
        }
        .dropdown-menu .list-item-click:hover {
            background-color: #e9ecef;
            color: #000;
        }
    `)
    .appendTo("head");



// --- Upload Modal Logic ---
$("#uploadModal").on("show.bs.modal", function (event) {
    const button = $(event.relatedTarget);
    const docId = button.data("doc");

    if (docId) {
    // Editing an existing document
    $("#uploadDocId").val(docId);
    $("#section").val(button.data("section")).trigger("change");

    // Wait until the dropdown is ready before setting doc type
    $(document).one("typesPopulated", function () {
        $("#documentType").val(button.data("doctype")).trigger("change");
    });

    $("#description").val(button.data("description"));
    $(".modal-title", this).text("Update Document");
    $("#saveDocumentBtn").text("Update")
        .removeClass("btn-primary").addClass("btn-warning");
    }else {
        // Fresh upload
        $("#uploadForm")[0].reset();
        $("#uploadDocId").val("");
        $("#documentType")
            .empty()
            .append('<option value="" disabled selected>Select a section first</option>')
            .prop("disabled", true);
        $(".modal-title", this).text("Upload Document");
        $("#saveDocumentBtn").text("Upload")
            .removeClass("btn-warning").addClass("btn-primary");
    }
});

// --- Populate document types dynamically from server-side list (Django) ---
$("#section").on("change", function () {
    const sectionId = $(this).val();
    const $documentType = $("#documentType");
    $documentType.empty().append('<option value="" disabled selected>Select a document type</option>');

    const sectionData = window.sectionItems ? window.sectionItems[sectionId] : null;
    if (sectionData) {
        sectionData.forEach(item => {
            if (item.categories) {
                for (const [category, subs] of Object.entries(item.categories)) {
                    subs.forEach(sub => {
                        $documentType.append(`<option value="${sub.name}">${sub.name}</option>`);
                    });
                }
            } else {
                $documentType.append(`<option value="${item.name}">${item.name}</option>`);
            }
        });
        $documentType.prop("disabled", false);
    } else {
        $documentType.prop("disabled", true);
    }

    // ✅ Fire event once dropdown is ready
    $(document).trigger("typesPopulated");
});


// --- Reviewer Modal ---
$("#reviewModal").on("show.bs.modal", function (event) {
    const button = $(event.relatedTarget);
    const docId = button.data("doc");
    const docName = button.data("doctype");
    const feedback = button.data("feedback");
    const status = button.data("status");

    $("#reviewDocId").val(docId);

    const actionTemplate = "{% url 'review_document_submit' 0 %}";
    const newAction = actionTemplate.replace("/0/", "/" + docId + "/");
    $("#reviewForm").attr("action", newAction);

    $("#status").val(status);
    $("#reviewer_feedback").val(feedback);
    $("#reviewDocumentName").text(docName);
});
</script>

{% endblock ScriptBlock %}
